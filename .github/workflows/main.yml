# 工作流名称：ML Service Build & Deploy
name: ML Service CI/CD Pipeline

# 触发条件：推送到任意分支、合并PR到任意分支
on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]

# 定义作业
jobs:
  # 作业1：测试Python代码，失败则整个CI终止
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest # 使用GitHub官方Ubuntu运行器
    steps:
      - name: Checkout Code # 拉取仓库代码到运行器
        uses: actions/checkout@v4
      - name: Set Up Python # 配置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: "3.11" # 与Docker镜像一致
          cache: "pip" # 缓存pip依赖，提升速度
      - name: Install Dependencies # 安装运行和测试依赖
        working-directory: /module3/milestone2 # 切换到项目目录
        run: |
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install pytest requests
      - name: Run Pytest # 执行单元测试
        working-directory: /module3/milestone2
        run: pytest tests/test_app.py -v

  # 作业2：构建并推送Docker镜像，依赖test作业通过
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: test # 仅当test作业成功时执行
    if: github.event_name == 'push' # 仅推送到仓库时执行，PR不推送
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Set Up Docker Buildx # 配置Docker构建工具，支持多架构（可选）
        uses: docker/setup-buildx-action@v3
      - name: Login to Container Registry # 登录课程容器仓库
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.REGISTRY_URL }} # 从Secrets获取仓库地址
          username: ${{ secrets.REGISTRY_USERNAME }} # 从Secrets获取用户名
          password: ${{ secrets.REGISTRY_PASSWORD }} # 从Secrets获取密码
      - name: Build & Push Docker Image # 构建并推送镜像
        uses: docker/build-push-action@v5
        with:
          context: /module3/milestone2 # Docker构建上下文（项目根目录）
          push: true # 开启推送
          # 打标：课程仓库/用户名/服务名:语义化版本
          tags: |
            ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_USERNAME }}/ml-service:v1.0.0
            ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_USERNAME }}/ml-service:latest # 可选：latest标签
          cache-from: type=gha # 缓存构建层，提升速度
          cache-to: type=gha,mode=max
